# Data cleaning

```{r data_merge}
#Flights data
data_2020 <- read.csv("data/2020-States.csv")
data_2021 <- read.csv("data/2021-States.csv")
data_2022 <- read.csv("data/2022-States.csv")
data_2023 <- read.csv("data/2023-States.csv")

#Merge all flights datasets together
data_2019 <- select(data_2020, Entity, Day.2019, Flights.2019..Reference.) %>% rename(Day = Day.2019, Flights = Flights.2019..Reference.)
data_2020 <- select(data_2020, Entity, Day, Flights)
data_2021 <- select(data_2021, Entity, Day, Flights)
data_2022 <- select(data_2022, Entity, Day, Flights)
data_2023 <- select(data_2023, Entity, Day, Flights)
data_all_years <- rbind(data_2019, data_2020, data_2021, data_2022, data_2023)

#Select only data where country == switzerland
flights <- data_all_years[data_all_years$Entity == 'Switzerland',]
flights$year_month = format(as.Date(flights$Day), "%Y-%m")

flights <- flights %>% select(Day,Flights) %>% set_names(c("Date", "Flights"))

#Convert the "Date" column to a date format:
#flights$Date <- parse_date_time(flights$Date, orders = c("%d-%b-%y", "%b %d, %Y"))
flights <- flights %>% mutate(Date = as.Date(Date, format = "%Y-%m-%d"))

```

```{r}
#Weather data
weather <- read_excel("data/switzerland weather.xlsx")

#Select appropriate columns (which covariates we will use)

weather <- weather %>% select(datetime,temp, precip, snow, windspeed, visibility, humidity)

#change column names to match with other datasets
colnames(weather)[1] <- "Date"

#Convert the "Date" column to a date format:
#weather$Date <- parse_date_time(weather$Date, orders = c("%d-%b-%y", "%b %d, %Y"))

#Some summary statistics for all columns
#weather %>% dfSummary(style = "grid")


```

```{r}
#Oil data 

oil <- read.csv("data/BrentOilPrices.csv")

#Check for NA's, there's none
#sum(is.na(oil))

#Convert the "Date" column to a date format:
oil$Date <- parse_date_time(oil$Date, orders = c("%d-%b-%y", "%b %d, %Y"))

#Summary statistics 
oil %>% dfSummary(style = "grid")


#Plot the time series 
ggplot(oil, aes(x = Date, y = Price)) +
  geom_line() +
  labs(title = "Brent Oil Prices (all data)", x = "Date", y = "Price")

#convert to tsibble object 
#oil <- oil %>%
  #mutate(Date = yearmonth(Date)) %>% #need to do this before converting to get proper format
  #as_tsibble(index = Date)

#Select appropriate dates
oil <- oil %>%
  mutate(Date = as.Date(Date)) %>%
  filter(Date > as.Date("2019-01-01"))

#Plot the time series 
ggplot(oil, aes(x = Date, y = Price)) +
  geom_line() +
  labs(title = "Brent Oil Prices 2019 onwards", x = "Date", y = "Price")

# create a complete sequence of dates from the minimum to maximum date
all_dates <- seq(min(oil$Date), max(oil$Date), by = "day")

# use complete() to create rows for the missing dates
oil_complete <- oil %>% 
  complete(Date = all_dates)

# replace missing prices with NA
oil_complete$Price[is.na(oil_complete$Price)] <- NA

#There are 426 missing values now that I have completed the oil dataset... 
sum(is.na(oil_complete))


```

```{r}
#Trying with another oil dataset...
newoil <- read.csv('data/crudeoil.csv')

#Converting date column to date type + format
newoil <- newoil %>%
  mutate(Date = as.Date(Date, format = "%m/%d/%Y"))

#Select relevant columns
newoil <- newoil %>% select(Date,Close.Last)

#Select relevant dates
newoil <- newoil %>%
  mutate(Date = as.Date(Date)) %>%
  filter(Date > as.Date("2019-01-01"))

#Plot the time series 
ggplot(newoil, aes(x = Date, y = Close.Last)) +
  geom_line() +
  labs(title = "Oil Prices 2019 onwards", x = "Date", y = "Price")

#Check for NA's -> There are no NA's for the moment
sum(is.na(newoil))


```



## TO DO: MERGE THE DATASETS -> DIFFERENT DATE COLUMN TYPES

```{r}
#Merging datasets together 
data <- flights %>%
  left_join(oil, by = "Date") %>%
  left_join(weather, by = "Date")

#Convert to tsibble object  
#ts_data <- data %>%
#  as_tsibble(index = Date)


#There is a problem converting to tsibble, because apparently there are duplicate dates
duplicates(data)

#Plot the time series 
#data %>% autoplot(Price) +
#  labs(title = "Brent Oil Prices 2019 onwards", x = "Date", y = "Price")






#TRYING WITH NEWOIL

#Merging datasets together 
newdata <- flights %>%
  left_join(newoil, by = "Date") %>%
  left_join(weather, by = "Date")

#There are 713 NA's if we use the newoil data
sum(is.na(newdata$Close.Last))

```

