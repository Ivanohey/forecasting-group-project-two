## Models using Weather variables

Here's what our flights-weather dataset looks like: 

```{r}
datatable(ts_data_weather, options = list(pageLength = 6))

```

### Forecasting Predictors with ETS 

```{r}

#Modelling ets automatically
ets_temp <- ts_data_weather_tr %>%
  model(ETS(temp))

#Getting the Accuracy scores for model
report(ets_temp)

#Forecasting using the model 
forecast_ets_temp <- ets_temp %>% forecast(h = 15)

#Graphing the forecast
ets_temp %>% forecast(h = 15) %>% autoplot(ts_data_weather_last6)+
  labs(title = "ETS Forecast for Temperature")

#What If I give ETS just 2 months of previous data?

#selecting data from September 2022 until the last 2 weeks of data to train this model
ts_data_weather_tr2 <- ts_data_weather %>% filter(Date >= as.Date("2022-09-01") & Date <= as.Date("2022-10-31") )

ets_temp2 <- ts_data_weather_tr2 %>%
  model(ETS(temp))
#Getting the Accuracy scores for model
#report(ets_temp2)
#Forecasting using the model 
#forecast_ets_temp2 <- ets_temp %>% forecast(h = 15)
ets_temp2 %>% forecast(h = 15) %>% autoplot(ts_data_weather_last6)+
  labs(title = "ETS Forecast for Temperature using 2 months of data -> still terrible")

```

Here we can see that the ETS model is complete garbage at predicting that temperatures will drop in November.

### Forecasting Predictors with SARIMA

```{r}
#Modelling ARIMA automatically
arima_temp <- ts_data_weather_tr %>%
  select(temp) %>%
  model(ARIMA(temp, stepwise = FALSE)) 

#Getting the Accuracy scores for model
report(arima_temp) #ARIMA(3,1,1)(2,0,0)[7]

#Forecasting using the models
forecast_arima_temp <- arima_temp %>% forecast(h = 15)

#Graphing the forecast
arima_temp %>% forecast(h = 15) %>% autoplot(ts_data_weather_last6)+
  labs(title = "SARIMA Forecast for Temperature")


```

Here we can see that the SARIMA model is complete garbage at predicting that temperatures will drop in November.

### Forecasting predictors using TSLM (regression)

I will finally use a TSLM model to forecast the weather data, starting with predicting the temperature based on the rest of the weather data values.

```{r}


#TEMPERATURE 


#Fitting the TSLM model
temp_tslm <- ts_data %>%
  model(tslm = TSLM(temp ~ precip + windspeed + humidity))
report(temp_tslm)

#Plotting the TSLM model
augment(temp_tslm) %>%
  ggplot(aes(x = Date)) +
  geom_line(aes(y = temp, colour = "Data")) +
  geom_line(aes(y = .fitted, colour = "Fitted")) + xlab("Year") + ylab(NULL) +
  guides(colour = guide_legend(title=NULL)) +
  labs(title = "TSLM to predict temperature")

#comparing the TSLM model with actual data to see how good/bad it is 
augment(temp_tslm) %>%
  ggplot(aes(x = temp, y = .fitted)) + geom_point() +
  ylab("Fitted (predicted values)") + xlab("Data (actual values)") +
  geom_abline(intercept = 0, slope = 1) +
  labs(title = "Fitted values vs Actual data Temperature- Looks not amazing")

#Getting the metrics 
glance(temp_tslm) %>% dplyr::select(adj_r_squared, CV, AIC, AICc, BIC)

#Getting the Forecast for November 2022: 
forecast_tslm_temp <- temp_tslm %>% forecast(new_data = ts_data_weather_te, h = 15) 
forecast_tslm_temp %>% autoplot(ts_data_weather_last6) + labs(title = "TSLM forecast for Temperature")

#Extracting the forecast values: 
forecast_table_tslm_temp <- as.data.frame(forecast_tslm_temp)
forecast_table_tslm_temp <- forecast_table_tslm_temp %>% select(Date,.mean)

#change col names
colnames(forecast_table_tslm_temp)[1] <- "Date"
colnames(forecast_table_tslm_temp)[2] <- "Temp TSLM"

#IGNORE THIS: 

#%>% autoplot(ts_data_weather_last6)+
#  labs(title = "SARIMA Forecast for Temperature")

#Getting the forecasts (HERE I USE A DIFFERENT FIT)
#temp_fit <- ts_data_weather_tr2 %>% model(TSLM(temp ~ trend() + season()))
#temp_tslm_fc <- forecast(temp_fit)
#plottingthe forecast 
#temp_tslm_fc %>% autoplot(ts_data_weather_last6) + xlab("Day") + ylab("Price")


#Getting the original forecast 
#forecast_tslm <- temp_tslm %>%
#  forecast(new_data = ts_data_weather_last6, h = 15)
#forecast_tslm %>% autoplot(ts_data_weather_last6)

```
Since this looks much better than what I was getting using SARIMA and ETS, I will use TSLM to forecast all of my predictor variables. At the moment, I don't have a metric to compare TSLM with ETS and SARIMA, I simply use my intuition based on the graph produced above. It clearly captured the usual drop in temperatures in November, whereas ETS and SARIMA produced a flat forecast.

```{r}


#PRECIPITATION 


#Fitting the TSLM model
precip_tslm <- ts_data %>%
  model(tslm = TSLM(precip ~ temp + windspeed + humidity))
report(precip_tslm)

#Plotting the TSLM model
augment(precip_tslm) %>%
  ggplot(aes(x = Date)) +
  geom_line(aes(y = precip, colour = "Data")) +
  geom_line(aes(y = .fitted, colour = "Fitted")) + xlab("Year") + ylab(NULL) +
  guides(colour = guide_legend(title=NULL)) +
  labs(title = "TSLM to predict precipitation")


#comparing the TSLM model with actual data to see how good/bad it is 
augment(precip_tslm) %>%
  ggplot(aes(x = precip, y = .fitted)) + geom_point() +
  ylab("Fitted (predicted values)") + xlab("Data (actual values)") +
  geom_abline(intercept = 0, slope = 1) +
  labs(title = "Fitted values vs Actual data Precipitation")

#Getting the metrics 
glance(precip_tslm) %>% dplyr::select(adj_r_squared, CV, AIC, AICc, BIC)

#Getting the Forecast for November 2022: 
forecast_tslm_precip <- precip_tslm %>% forecast(new_data = ts_data_weather_te, h = 15) 
forecast_tslm_precip %>% autoplot(ts_data_weather_last6) + labs(title = "TSLM forecast for Precipitation")

#Extracting the forecast values: 
forecast_table_tslm_precip <- as.data.frame(forecast_tslm_precip)
forecast_table_tslm_precip <- forecast_table_tslm_precip %>% select(Date,.mean)

#change col names
colnames(forecast_table_tslm_precip)[1] <- "Date"
colnames(forecast_table_tslm_precip)[2] <- "Precip TSLM"

```

```{r}


#WINDSPEED 


#Fitting the TSLM model
windspeed_tslm <- ts_data %>%
  model(tslm = TSLM(windspeed ~ temp + precip + humidity))
report(windspeed_tslm)

#Plotting the TSLM model
augment(windspeed_tslm) %>%
  ggplot(aes(x = Date)) +
  geom_line(aes(y = windspeed, colour = "Data")) +
  geom_line(aes(y = .fitted, colour = "Fitted")) + xlab("Year") + ylab(NULL) +
  guides(colour = guide_legend(title=NULL)) +
  labs(title = "TSLM to predict windspeed")


#comparing the TSLM model with actual data to see how good/bad it is 
augment(windspeed_tslm) %>%
  ggplot(aes(x = windspeed, y = .fitted)) + geom_point() +
  ylab("Fitted (predicted values)") + xlab("Data (actual values)") +
  geom_abline(intercept = 0, slope = 1) +
  labs(title = "Fitted values vs Actual data Windspeed")

#Getting the metrics 
glance(windspeed_tslm) %>% dplyr::select(adj_r_squared, CV, AIC, AICc, BIC)

#Getting the Forecast for November 2022: 
forecast_tslm_windspeed <- windspeed_tslm %>% forecast(new_data = ts_data_weather_te, h = 15) 
forecast_tslm_windspeed %>% autoplot(ts_data_weather_last6) + labs(title = "TSLM forecast for Windspeed")

#Extracting the forecast values: 
forecast_table_tslm_windspeed <- as.data.frame(forecast_tslm_windspeed)
forecast_table_tslm_windspeed <- forecast_table_tslm_windspeed %>% select(Date,.mean)

#change col names
colnames(forecast_table_tslm_windspeed)[1] <- "Date"
colnames(forecast_table_tslm_windspeed)[2] <- "Windspeed TSLM"

```

```{r}


#HUMIDITY 


#Fitting the TSLM model
humidity_tslm <- ts_data %>%
  model(tslm = TSLM(humidity ~ temp + precip + windspeed))
report(humidity_tslm)

#Plotting the TSLM model
augment(humidity_tslm) %>%
  ggplot(aes(x = Date)) +
  geom_line(aes(y = humidity, colour = "Data")) +
  geom_line(aes(y = .fitted, colour = "Fitted")) + xlab("Year") + ylab(NULL) +
  guides(colour = guide_legend(title=NULL)) +
  labs(title = "TSLM to predict humidity")


#comparing the TSLM model with actual data to see how good/bad it is 
augment(humidity_tslm) %>%
  ggplot(aes(x = humidity, y = .fitted)) + geom_point() +
  ylab("Fitted (predicted values)") + xlab("Data (actual values)") +
  geom_abline(intercept = 0, slope = 1) +
  labs(title = "Fitted values vs Actual data Humidity")

#Getting the metrics 
glance(humidity_tslm) %>% dplyr::select(adj_r_squared, CV, AIC, AICc, BIC)

#Getting the Forecast for November 2022: 
forecast_tslm_humidity <- humidity_tslm %>% forecast(new_data = ts_data_weather_te, h = 15) 
forecast_tslm_humidity %>% autoplot(ts_data_weather_last6) + labs(title = "TSLM forecast for Humidity")

#Extracting the forecast values: 
forecast_table_tslm_humidity <- as.data.frame(forecast_tslm_humidity)
forecast_table_tslm_humidity <- forecast_table_tslm_humidity %>% select(Date,.mean)

#change col names
colnames(forecast_table_tslm_humidity)[1] <- "Date"
colnames(forecast_table_tslm_humidity)[2] <- "Humidity TSLM"

```

At this point we have forecasts for all of our weather covariates: temperature, precipitation, windspeed and humidity. 