```{r converting__all_data_to_tsibble}
#Holidays to tsibble
Holidays = school_holidays_df
Holidays_ts = as_tsibble(Holidays,index = Date)

#Flights to tsibble
Swiss_Traffic_tsibble = as_tsibble(Swiss_Traffic, index = date)



#Seasonal decomposition of the flights
dcmp_swiss = Swiss_Traffic_tsibble %>% model(stl = STL(departures))
components(dcmp_swiss) %>% autoplot()

```
As seen on the ETS decomposition above, there is a strong seasonal component and a noticeable break in the 

```{r holidays decomposition}
autoplot(Holidays_ts, is_holiday) 
dcmp_holidays = Holidays_ts %>% model(stl = STL(is_holiday))
components(dcmp_holidays) %>% autoplot()

```

From the ETS decomposition above it is very difficult to interpret the trend. Even though it is growing, it doesn't really make sense to speak of growth when analysing binary data. On the other hand, the yearly seasonality component and the remainder help to better spot where our data contains variations from one year to another. In fact we can see that generally the first half of the year contains more variable holidays than the second one. Therefore, this part will be more difficult to predict and forecasting flights during this period of time will introduce more variance in the forecast.


```{r plotting}

Holidays = rename(Holidays, date = Date)
Flights_Holidays = left_join(Swiss_Traffic, Holidays, by="date") %>% group_by(date) %>% summarise(departures = sum(departures), is_holiday = is_holiday)
Flights_Holidays_Covid = Flights_Holidays[Flights_Holidays$date <= as.Date("2020-01-31"),]

#Plot the flights until COVID and holidays
flights_holidays_plot_covid = ggplot(data = Flights_Holidays_Covid) +
  geom_line(aes(x = date, y = departures)) +
  geom_line(aes(x = date, y = ifelse(is_holiday, max(departures) -150, NA), color = "is_holiday"), size = 3) + 
  scale_y_continuous(name = "Departures") +
  ggtitle("Flights until Covid")
flights_holidays_plot_covid

#Plot the flights until today
flights_holidays_plot = ggplot(data = Flights_Holidays) +
  geom_line(aes(x = date, y = departures)) +
  geom_line(aes(x = date, y = ifelse(is_holiday, max(departures) /2, NA), color = "is_holiday"), size = 3) + 
  scale_y_continuous(name = "Departures") +
  ggtitle("Flights until 2023")
flights_holidays_plot

```

```{r log_transformed}

#Log transformation of the data
flights_until_covid_log = Flights_Holidays_Covid 
flights_until_covid_log$departures = log10(flights_until_covid_log$departures)
flights_holidays_log = Flights_Holidays
flights_holidays_log$departures = log10(flights_holidays_log$departures)

#Plotting with transformed data
#Plot the flights until COVID and holidays
flights_holidays_plot_covid = ggplot(data = flights_until_covid_log) +
  geom_line(aes(x = date, y = departures)) +
  geom_line(aes(x = date, y = ifelse(is_holiday, max(departures) - 0.1, NA), color = "is_holiday"), size = 4) + 
  scale_y_continuous(name = "Departures") +
  ggtitle("Flights until Covid (log transformed)")
flights_holidays_plot_covid

#Plot the flights until today
flights_holidays_plot = ggplot(data = flights_holidays_log) +
  geom_line(aes(x = date, y = departures)) +
  geom_line(aes(x = date, y = ifelse(is_holiday, max(departures) -0.2, NA), color = "is_holiday"), size = 7) +
  
  scale_y_continuous(name = "Departures") +
  ggtitle("Flights until Covid (log transformed)")
flights_holidays_plot

```
As we can see on the plots above, the periods of holidays seem coincide with spikes in the amounts of flights going from Switzerland. This makes sense since it is known that people take planes to go on remote locations for holidays. We can also observe that when there are no holidays for a longer period of time, the number of flights tend to drop, as it can be seen clearly in the end of 2022 or 2023. Now let's look at the correlation between holidays and the number of flights. As we are working with time series, we first need to make our data stationary before studying correlation. In order to achieve that, we first performed a log transformation of our data to reduce the range of our values and make it easier to work with later. Then we decided to use the variation of the number of flights in percentage instead of using the raw number of flights. In fact, it should help us to see if holidays are correlated with increases or decreases in flights.
```{r biseral_plot}

#Biserial plot with data only until covid
biserial_plot = ggplot(data=Flights_Holidays_Covid) + geom_point(aes(y=departures, x=as.factor(is_holiday)), size=0.5, position=position_jitter(width=0.05)) +
  scale_x_discrete(name = "is a holiday")
biserial_plot

#Undersampling the data to have same quantity of holidays and normal days:
min_count = min(table(Flights_Holidays_Covid$is_holiday))
balanced_data = Flights_Holidays_Covid %>% group_by(is_holiday) %>% sample_n(min_count)
biserial_plot_balanced = ggplot(data=balanced_data) + geom_point(aes(y=departures, x=as.factor(is_holiday)), size=0.5, position=position_jitter(width=0.05)) +
  scale_x_discrete(name = "is a holiday")
biserial_plot_balanced

```


```{r correlations}

set.seed(123)

#cor.test(flights_holidays_log$departures, flights_holidays_log$is_holiday)
corr = cor.test(Flights_Holidays$departures, Flights_Holidays$is_holiday)
print(corr)
```
Null hypothesis: There is no correlation
Alternative hypothesis: There is a correlation
Using Pearson's correlation test, we observe that our p-value is (0.00018 < 0.05) for a 95% confidence interval, in this case we reject the null hypothesis meaning that the values appear to be correlated.

This shows evidence of our initial assumption that holidays impact the number of flights.

We can confirm this by looking at the data before COVID 19:

```{r correlation_before_covid}
set.seed(123)

corr_before_covid = cor.test(Flights_Holidays_Covid$departures, Flights_Holidays_Covid$is_holiday)
print(corr_before_covid)

```

As seen in the results above, we have an even stronger correlation score and a smaller p-value for data recorded until Covid, meaning that we can reject the null hypothesis stating that variables are not correlated. The ability to predict holidays efficiently allows us to use this information as covariate for predicting the number of flights.

```{r arima_model_with_covid }
#With covid
holidays_total = Flights_Holidays %>% mutate(is_holiday = as.factor(is_holiday)) %>% as_tsibble()
holidays_train_set = holidays_total %>% filter(date < as.Date("2022-01-01"))
holidays_test_set = holidays_total %>% filter(date >= as.Date("2022-01-01") & date <= as.Date("2022-10-31"))


#Without holidays
arima_flights = holidays_train_set %>% 
  model(ARIMA(departures, stepwise= FALSE, approximation = FALSE)) %>% 
  forecast(h = nrow(holidays_test_set))

#With holidays
sarimax_flights = holidays_train_set %>% 
  model(ARIMA(departures ~ is_holiday, stepwise= FALSE)) %>% 
  forecast(new_data = as_tsibble(holidays_test_set))

autoplot(arima_flights) +
  geom_line(aes(x=holidays_test_set$date, y=holidays_test_set$departures)) +
  ggtitle("ARIMA model for whole time frame")

autoplot(sarimax_flights) +
  geom_line(aes(x=holidays_test_set$date, y=holidays_test_set$departures)) +
  ggtitle("SARIMAX model with for holiday regressor")

```



```{r arima_model_before_covid}
#Before covid
str(Flights_Holidays_Covid)

#Creating train and test sets
holidays_total_covid = Flights_Holidays_Covid %>% mutate(is_holiday = as.factor(is_holiday)) %>% as_tsibble()
holidays_train_covid = holidays_total_covid %>% filter( date < as.Date("2019-08-01"))
holidays_test_covid = holidays_total_covid %>% filter(date >= as.Date("2019-08-01"))


#Without holidays
arima_flights_holidays = holidays_train_covid %>% 
  model(ARIMA(departures, stepwise= FALSE)) %>% 
  forecast(h = nrow(holidays_test_covid))

#With holidays
sarimax_flights_holidays = holidays_train_covid %>% 
  model(ARIMA(departures ~ is_holiday, stepwise= FALSE)) %>% 
  forecast(new_data = as_tsibble(holidays_test_covid))


#Plotting

#Without regressors
autoplot(arima_flights_holidays) +
  geom_line(aes(x=holidays_test_covid$date, y=holidays_test_covid$departures)) +
  ggtitle("ARIMA forecast")

#With regressors
autoplot(sarimax_holiday) + 
  geom_line(aes(x = holidays_test_covid$date, y = holidays_test_covid$departures)) +
  ggtitle("SARIMAX forecast with is_holiday regressor") 


```